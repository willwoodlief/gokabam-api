<!--Cannot use bootstrap in the text area highlighting, so need clean page to test with-->
<!doctype html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <title>API</title>
    <script
            src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous">
    </script>

    <!-- Include Ace editor first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/ace.js"></script>
    <!-- Include Ace-diff JS and CSS (using unpkg.com CDN in this case) -->
    <script src="node_modules/ace-diff/dist/ace-diff.min.js"></script>
    <link href="node_modules/ace-diff/dist/ace-diff.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">


    <!--suppress JSUnusedLocalSymbols -->
    <script type='text/javascript'>
        //nonce will expire, go to wp page and copy in new nonce once a day
        var gokabam_api_frontend_ajax_obj = {"ajax_url":"http://localhost/wordpress/wp-admin/admin-ajax.php","action":"gokabam_api_submit_chart_step","nonce":"e089d6fdbc","plugins_url":"http://localhost/wordpress/wp-content/plugins"};
    </script>

    <script src="public/js/public.js"></script>

    <style>
        html,body {height: 100%;}
        div.gk-wrap {position:relative;padding: 0;margin: auto;width: 95%; height: 95%;background-color: green}
        div.gk-side {width:100%;height: 6%; background-color: lightgrey;text-align: center}
        div.gk-side button.gk-talker {width: 5em; float: left; margin-left: 4em; height: 2em; font-size: large;font-weight: bold; margin-top: 5px}
        div.gk-main {position:absolute;top:6%; left:0;width: 100%;height: 94%; background-color: yellow}
        i.gk-spinner {display: none;font-size:2em;margin-right: 2em;color:green}
        span.gk-status {color: green;}
        span.gk-status-error {color:darkred;}
        div.gk-infobar {display: inline-block;float:right;margin-top: 5px; margin-right:4em;position: relative}
    </style>


    <script>

        let rightEditor=null,leftEditor = null,lastCall=null,nowCall=null;
        function cycleEditors(obj) {
            lastCall = nowCall;
            nowCall = JSON.stringify(obj, null, '\t');
            leftEditor.setValue(nowCall);
            leftEditor.clearSelection();
            if (!lastCall) {
                lastCall = '';
            }
            rightEditor.setValue(lastCall);
            rightEditor.clearSelection();
        }

        $(function() {
            // noinspection ES6ModulesDependencies
            var aceDiffer = new AceDiff({
                mode: 'ace/mode/json',
                element: '.gk-main',
                diffGranularity: 'specific',
                left: {
                    content: '',
                },
                right: {
                    content: '',
                },
            });




           // aceDiffer.editors.right.ace.setTheme('ace/theme/katzenmilch');
            aceDiffer.editors.left.ace.getSession().setUseWrapMode(true);
            aceDiffer.editors.right.ace.getSession().setUseWrapMode(true);

            rightEditor = aceDiffer.editors.right.ace;
            leftEditor = aceDiffer.editors.left.ace;

            let status_span = $('span.gk-status');

            $('.gk-talker').click(function() {
                status_span.text('').removeClass('gk-status-error');
                let hugs = {};
                let words = leftEditor.getValue();
                words = words.trim();
                if (!words) {
                    hugs = {api_action: 'init',pass_through_data: 'no input, so asking initizing'};
                } else {
                    try {
                        hugs = JSON.parse(words);
                    } catch (e) {
                        status_span.text(e.message).addClass('gk-status-error');
                        return;
                    }
                }



                if ($.isEmptyObject(hugs)) {
                    hugs = {api_action: 'init',pass_through_data: 'empty object after parsing, so asking initizing'};
                }
                $('.gk-spinner').show();

                $.GokabamTalk('gokabam_api',
                    {gokabam_api_data:hugs},
                    function(data) {
                        $('.gk-spinner').hide();
                        $('span.gk-status').text('success').removeClass('gk-status-error');

                        cycleEditors(data);
                    },
                    function(message) {
                        $('.gk-spinner').hide();
                        if ((typeof message === "string") && (message.length > 0)) {
                            $('span.gk-status').text(message).addClass('gk-status-error');
                        } else {
                            $('span.gk-status').text('ERROR').addClass('gk-status-error');
                        }

                        cycleEditors(message);
                    }
                )
            });

        });





    </script>
</head>
<body>

<div class="gk-wrap">
    <div class="gk-side">
        <div class="gk-infobar">
            <span class="gk-status" style="margin-left: 2em;"> have a nice day!</span>
            <i class="fa fa-spinner fa-spin gk-spinner" ></i>
        </div>
        <button type="button" class="gk-talker" > Talk </button>
    </div>

    <div class="gk-main">

    </div>
</div>

</body>
</html>